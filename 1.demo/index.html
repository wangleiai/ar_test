<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js ar - hit test</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="main.css">
</head>

<body>

	<div id="info">
		<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> ar - hit test<br />(Chrome Android
		81+)
	</div>

	<script type="importmap">
			{
				"imports": {
					"three": "./build/three.module.js",
					"three/addons/": "./jsm/"
				}
			}
		</script>

	<script type="module">

		import * as THREE from 'three';
		import { ARButton } from 'three/addons/webxr/ARButton.js';
		import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

		let container;
		let camera, scene, renderer;
		let controller;

		let reticle;
		let koalaModel;

		let hitTestSource = null;
		let hitTestSourceRequested = false;

		init();
		animate();

		function init() {

			container = document.createElement('div');
			document.body.appendChild(container);

			scene = new THREE.Scene();

			// camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
			camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

			camera.position.z = 5;

			/*
			const light = new THREE.HemisphereLight( 0xffffff, 0xbbbbff, 3 );
			light.position.set( 0.5, 1, 0.25 );
			scene.add( light ); 
			*/


			// 创建GLTF加载器对象
			const loader = new GLTFLoader();
			//加载模型文件，返回gltf对象
			/*loader.load( './assets/models/koala.glb', function ( gltf ) {
				console.log('控制台查看加载gltf文件返回的对象结构',gltf);
				console.log('gltf对象场景属性',gltf.scene);
				// 返回的场景对象gltf.scene插入到threejs场景中
				
				scene.add( gltf.scene );
			})
			*/
			loader.load("./assets/models/koala.glb", function (gltf) {
				const ambientLight = new THREE.AmbientLight(0xffffff, 1); // 白光，强度为1
				scene.add(ambientLight);

				const dirLight = new THREE.DirectionalLight('rgb(253,253,253)', 5);
				dirLight.position.set(1, 1, 1); // 根据需要自行调整位置

				scene.add(dirLight);

				gltf.scene.traverse((child) => {
					if (child.isMesh) {
						child.material.side = THREE.DoubleSide; // 模型双面渲染
						child.castShadow = true;  // 光照是否有阴影
						child.receiveShadow = true;  // 是否接收阴影
						child.frustumCulled = false;
					}
				});
				koalaModel = gltf.scene;
				scene.add(koalaModel);
				console.log(koalaModel)

			});


			//

			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.xr.enabled = true;
			container.appendChild(renderer.domElement);

			//

			document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

			//

			function onSelect() {
				// console.log("select ")

				if (koalaModel.visible) {

					// loader.load("./assets/models/koala.glb", function (gltf) {
					// 	const ambientLight = new THREE.AmbientLight(0xffffff, 1); // 白光，强度为1
					// 	scene.add(ambientLight);

					// 	const dirLight = new THREE.DirectionalLight('rgb(253,253,253)', 5);
					// 	dirLight.position.set(1, 1, 1); // 根据需要自行调整位置

					// 	scene.add(dirLight);

					// 	gltf.scene.traverse((child) => {
					// 		if (child.isMesh) {
					// 			child.material.side = THREE.DoubleSide; // 模型双面渲染
					// 			child.castShadow = true;  // 光照是否有阴影
					// 			child.receiveShadow = true;  // 是否接收阴影
					// 			child.frustumCulled = false;
					// 		}
					// 	});

					// 	scene.add(gltf.scene);

					// });

					// const model = koalaModel.clone(); // TODO: 使用clone会新增一个模型上去
					const model = koalaModel;

					// Place the model on the spot where the marker is showing.
					// model.position.setFromMatrixPosition(planeMarker.matrix);

					// Rotate the model randomly to give a bit of variation.
					model.rotation.y = Math.random() * (Math.PI * 2);
					model.visible = true;
					scene.add(model);
					console.log(scene)

				}

			}

			controller = renderer.xr.getController(0);
			controller.addEventListener('select', onSelect);
			scene.add(controller);

			// reticle = new THREE.Mesh(
			// 	new THREE.RingGeometry(0.15, 0.2, 32).rotateX(- Math.PI / 2),
			// 	new THREE.MeshBasicMaterial()
			// );
			// reticle.matrixAutoUpdate = false;
			// reticle.visible = false;
			// scene.add(reticle);

			//

			window.addEventListener('resize', onWindowResize);

		}

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		//

		function animate() {

			renderer.setAnimationLoop(render);

		}

		function render(timestamp, frame) {

			if (frame) {

				const referenceSpace = renderer.xr.getReferenceSpace();
				const session = renderer.xr.getSession();

				if (hitTestSourceRequested === false) {

					session.requestReferenceSpace('viewer').then(function (referenceSpace) {

						session.requestHitTestSource({ space: referenceSpace }).then(function (source) {

							hitTestSource = source;

						});

					});

					session.addEventListener('end', function () {

						hitTestSourceRequested = false;
						hitTestSource = null;

					});

					hitTestSourceRequested = true;

				}

				if (hitTestSource) {

					const hitTestResults = frame.getHitTestResults(hitTestSource);

					if (hitTestResults.length) {

						const hit = hitTestResults[0];

						koalaModel.visible = true;
						koalaModel.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);

					} else {

						koalaModel.visible = false;

					}

				}

			}

			renderer.render(scene, camera);

		}

	</script>
</body>

</html>